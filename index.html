<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ì°¨ê³„ë¶€ ì •ë¹„ë‚´ì—­ ì›¹ì•±</title>
  <style>
    :root { --bg:#0f172a; --card:#111827; --ink:#e5e7eb; --muted:#94a3b8; --accent:#22d3ee; }
    *{ box-sizing: border-box; }
    body{ margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Noto Sans, "Apple SD Gothic Neo", "Nanum Gothic", sans-serif; background:var(--bg); color:var(--ink); display:flex; }
    header{ padding:20px; border-bottom:1px solid #1f2937; position:sticky; top:0; background:linear-gradient(180deg,#0f172a 0%, rgba(15,23,42,0.9) 100%); backdrop-filter: blur(6px); z-index:10; }
    h1{ margin:0; font-size:20px; letter-spacing:0.3px; }
    .container{ flex:1; max-width:1000px; margin:20px auto; padding:0 16px 40px; }
    .card{ background:var(--card); border:1px solid #1f2937; border-radius:16px; padding:16px; box-shadow: 0 10px 30px rgba(0,0,0,0.25); margin-bottom:16px; }
    .grid{ display:grid; gap:12px; }
    .grid.cols-3{ grid-template-columns: repeat(3, minmax(0,1fr)); }
    .row{ display:flex; gap:8px; align-items:center; }
    label{ font-size:12px; color:var(--muted); display:block; margin-bottom:6px; }
    input, select, textarea{ width:100%; padding:10px 12px; background:#0b1220; color:var(--ink); border:1px solid #1f2937; border-radius:10px; outline:none; }
    input:focus, textarea:focus{ border-color: var(--accent); box-shadow: 0 0 0 4px rgba(34,211,238,0.1); }
    textarea{ min-height:64px; resize:vertical; }
    .btns{ display:flex; flex-wrap:wrap; gap:10px; }
    button{ padding:10px 14px; border-radius:12px; border:1px solid #1f2937; cursor:pointer; background:#0b1220; color:#fff; }
    button.primary{ background: linear-gradient(135deg, #22d3ee, #3b82f6); border:none; color:#00131a; font-weight:700; }
    button:disabled{ opacity:0.6; cursor:not-allowed; }
    .help{ font-size:12px; color:var(--muted); }
    .status{ margin-top:8px; font-size:13px; }
    table{ width:100%; border-collapse: collapse; }
    th, td{ padding:10px; border-bottom:1px solid #1f2937; font-size:14px; text-align:left; vertical-align:top; }
    th{ position:sticky; top:70px; background:var(--card); z-index:5; }
    .pill{ padding:2px 8px; border-radius:999px; background:#0b1220; border:1px solid #1f2937; font-size:12px; color:var(--muted); }
    .right{ text-align:right; }
    .nowrap{ white-space:nowrap; }
    .highlight{ font-family: 'Malgun Gothic', sans-serif; color: orange; font-weight:bold; }
    .sidebar{ width:260px; border-left:1px solid #1f2937; padding:20px; background:#111827; }
    .sidebar h2{ margin:0; font-size:16px; display:flex; align-items:center; justify-content:space-between; gap:8px; }
    .sidebar .gear{ width:28px; height:28px; display:inline-flex; align-items:center; justify-content:center; border-radius:8px; background:#0b1220; border:1px solid #1f2937; cursor:pointer; }
    .recent{ background:#0b1220; border-radius:10px; padding:10px; font-size:14px; margin-top:10px; }

    /* ì„¤ì • ëª¨ë‹¬ */
    .modal-backdrop{ position:fixed; inset:0; background:rgba(0,0,0,0.55); display:none; align-items:center; justify-content:center; z-index:100; backdrop-filter: blur(2px); }
    .modal{ width:min(560px, 92vw); background:var(--card); border:1px solid #1f2937; border-radius:16px; padding:16px; box-shadow:0 20px 60px rgba(0,0,0,0.45); }
    .modal h3{ margin:0 0 8px; font-size:18px; }
    .modal .row-end{ display:flex; gap:8px; justify-content:flex-end; margin-top:12px; }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>ğŸš— ì°¨ê³„ë¶€ ì •ë¹„ë‚´ì—­ â€¢ í´ë¼ìš°ë“œ ì €ì¥</h1>
    </header>

    <!-- ì…ë ¥ í¼ -->
    <section class="card">
      <div class="grid cols-3">
        <div>
          <label>ë‚ ì§œ <span class="pill">í•„ìˆ˜</span></label>
          <input type="date" id="fDate" />
        </div>
        <div>
          <label>í‚¤ë¡œìˆ˜</label>
          <input type="number" id="fOdo" inputmode="numeric" placeholder="ì˜ˆ) 67500" />
        </div>
        <div>
          <label>í•­ëª© <span class="pill">í•„ìˆ˜</span></label>
          <input type="text" id="fItem" placeholder="ì˜ˆ) ì—”ì§„ì˜¤ì¼ êµí™˜" />
        </div>
      </div>
      <div class="grid cols-3" style="margin-top:12px;">
        <div>
          <label>ê¸ˆì•¡(ì›)</label>
          <input type="number" id="fCost" inputmode="numeric" placeholder="ì˜ˆ) 59900" />
        </div>
        <div>
          <label>ì‚¬ìœ </label>
          <input type="text" id="fReason" placeholder="ì˜ˆ) ë°©ì „ / ì†Œëª¨í’ˆ êµí™˜ ë“±" />
        </div>
        <div>
          <label>ë¹„ê³ </label>
          <input type="text" id="fNote" placeholder="ì˜ˆ) ë§¤ì¥/ë¶€í’ˆ/ì˜¤ì¼ ê·œê²© ë“±" />
        </div>
      </div>
      <div class="grid" style="margin-top:12px;">
        <div>
          <label>ì°¸ê³ ì‚¬í•­</label>
          <textarea id="fRef" placeholder="ì •ë¹„ì— ì°¸ê³ í•  ë©”ëª¨"></textarea>
        </div>
        <div>
          <label>ì •ë¹„ ì˜ˆì • ì‚¬í•­</label>
          <textarea id="fNext" placeholder="ë‹¤ìŒ êµí™˜ì£¼ê¸°/ì˜ˆì • ì‘ì—…"></textarea>
        </div>
      </div>
      <div class="btns" style="margin-top:12px;">
        <button class="primary" id="addBtn">ì¶”ê°€</button>
        <button id="loadBtn">ëª©ë¡ ìƒˆë¡œê³ ì¹¨</button>
        <button id="deleteBtn">ì„ íƒ ì‚­ì œ</button>
        <button id="exportBtn">CSV ë‚´ë³´ë‚´ê¸°</button>
      </div>
      <div class="status" id="formStatus"></div>
    </section>

    <!-- ëª©ë¡ -->
    <section class="card">
      <div class="row" style="justify-content:space-between; margin-bottom:8px;">
        <div class="help">ì‹œíŠ¸ì˜ í—¤ë”ëŠ” <b>ë‚ ì§œ, í‚¤ë¡œìˆ˜, í•­ëª©, ê¸ˆì•¡, ë¹„ê³ , ì‚¬ìœ , ì°¸ê³ ì‚¬í•­, ì •ë¹„ ì˜ˆì • ì‚¬í•­</b></div>
        <div class="pill"><span id="count">0</span> ê±´</div>
      </div>
      <div style="overflow:auto;">
        <table id="table">
          <thead>
            <tr>
              <th><input type="checkbox" id="checkAll"></th>
              <th class="highlight">ë‚ ì§œ</th>
              <th class="highlight">í‚¤ë¡œìˆ˜</th>
              <th class="highlight">í•­ëª©</th>
              <th class="right">ê¸ˆì•¡</th>
              <th>ë¹„ê³ </th>
              <th>ì‚¬ìœ </th>
              <th>ì°¸ê³ ì‚¬í•­</th>
              <th>ì •ë¹„ ì˜ˆì • ì‚¬í•­</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </section>
  </div>

  <!-- ìš°ì¸¡ ì‚¬ì´ë“œë°” -->
  <div class="sidebar">
    <h2>
      <span>ğŸ“Œ ìµœê·¼ ì •ë¹„</span>
      <button class="gear" id="openSettings" title="ì„¤ì •">âš™</button>
    </h2>
    <div class="recent" id="recentBox">ì•„ì§ ë°ì´í„° ì—†ìŒ</div>
  </div>

  <!-- ì„¤ì • ëª¨ë‹¬ -->
  <div class="modal-backdrop" id="settingsModal">
    <div class="modal">
      <h3>ì—°ê²° ì„¤ì •</h3>
      <div class="grid" style="gap:10px;">
        <div>
          <label>Apps Script ì›¹ì•± URL</label>
          <input id="cfgUrl" placeholder="ì˜ˆ) https://script.google.com/macros/s/AKfycb.../exec" />
        </div>
        <div>
          <label>API Key (ì„ íƒ)</label>
          <input id="cfgKey" placeholder="ìŠ¤í¬ë¦½íŠ¸ ì†ì„±ì— ì„¤ì •í•œ ê°’" />
        </div>
        <div class="row" style="justify-content:flex-end; gap:8px;">
          <button id="closeSettings">ë‹«ê¸°</button>
          <button class="primary" id="saveCfgBtn">ì €ì¥</button>
        </div>
      </div>
      <div class="status" id="cfgStatus"></div>
    </div>
  </div>

  <script>
    const qs = (s,root=document)=> root.querySelector(s);
    const qsa = (s,root=document)=> [...root.querySelectorAll(s)];

    function setStatus(el,msg,type='info'){
      if(!el) return;
      el.textContent = msg;
      el.style.color = type==='error' ? '#fca5a5' : (type==='ok' ? '#86efac' : '#94a3b8');
    }

    // ì„¤ì • ì €ì¥/ë¶ˆëŸ¬ì˜¤ê¸°
    function loadConfig(){
      return { url: localStorage.getItem('carlog:url')||'', key: localStorage.getItem('carlog:key')||'' };
    }
    function saveConfig({url,key}){
      localStorage.setItem('carlog:url', (url||'').trim());
      localStorage.setItem('carlog:key', (key||'').trim());
    }

    function openSettings(){
      const {url,key} = loadConfig();
      qs('#cfgUrl').value = url;
      qs('#cfgKey').value = key;
      qs('#settingsModal').style.display = 'flex';
      setStatus(qs('#cfgStatus'), 'ë¸Œë¼ìš°ì €ì—ë§Œ ì €ì¥ë©ë‹ˆë‹¤.');
    }
    function closeSettings(){ qs('#settingsModal').style.display = 'none'; }

    function serializeForm(){
      const d = qs('#fDate').value;
      const item = qs('#fItem').value.trim();
      if(!d || !item) throw new Error('ë‚ ì§œì™€ í•­ëª©ì€ í•„ìˆ˜ì…ë‹ˆë‹¤.');
      return {
        apiKey: loadConfig().key || undefined,
        'ë‚ ì§œ': new Date(d).toISOString().slice(0,10),
        'í‚¤ë¡œìˆ˜': qs('#fOdo').value,
        'í•­ëª©': item,
        'ê¸ˆì•¡': qs('#fCost').value,
        'ë¹„ê³ ': qs('#fNote').value.trim(),
        'ì‚¬ìœ ': qs('#fReason').value.trim(),
        'ì°¸ê³ ì‚¬í•­': qs('#fRef').value.trim(),
        'ì •ë¹„ ì˜ˆì • ì‚¬í•­': qs('#fNext').value.trim(),
      };
    }

    async function addEntry(){
      try{
        const {url} = loadConfig();
        if(!url) throw new Error('ì„¤ì •ì—ì„œ ì›¹ì•± URLì„ ë¨¼ì € ì €ì¥í•˜ì„¸ìš”. (ì˜¤ë¥¸ìª½ âš™)');
        const body = serializeForm();
        setStatus(qs('#formStatus'),'ì €ì¥ ì¤‘...');
        const res = await fetch(url, { method:'POST', headers:{'Content-Type':'text/plain'}, body: JSON.stringify(body)});
        const data = await res.json();
        if(!data.ok) throw new Error(data.error);
        setStatus(qs('#formStatus'),'ì €ì¥ ì™„ë£Œ','ok');
        qsa('input[type="text"], input[type="number"], textarea').forEach(el=> el.value='');
        loadEntries();
      }catch(e){ setStatus(qs('#formStatus'),'ì €ì¥ ì‹¤íŒ¨: '+e.message,'error'); }
    }

    function fmtMoney(x){ if(!x) return ''; const n=Number(x); return isNaN(n)?x:n.toLocaleString('ko-KR'); }
    function fmtDate(v){ if(!v) return ''; const d=new Date(v); return isNaN(d)?v:d.toISOString().slice(0,10); }

    async function loadEntries(){
      const {url}=loadConfig();
      if(!url) return;
      try{
        const res=await fetch(url+'?list=1');
        const data=await res.json();
        const rows=data.data||[];
        const tbody=qs('#table tbody');
        tbody.innerHTML='';
        qs('#count').textContent=rows.length;
        rows.forEach((r,i)=>{
          const tr=document.createElement('tr');
          tr.innerHTML=`<td><input type='checkbox' data-idx='${i}'></td>
            <td>${fmtDate(r['ë‚ ì§œ'])}</td>
            <td>${r['í‚¤ë¡œìˆ˜']||''}</td>
            <td>${r['í•­ëª©']||''}</td>
            <td class='right'>${fmtMoney(r['ê¸ˆì•¡'])}</td>
            <td>${r['ë¹„ê³ ']||''}</td>
            <td>${r['ì‚¬ìœ ']||''}</td>
            <td>${r['ì°¸ê³ ì‚¬í•­']||''}</td>
            <td>${r['ì •ë¹„ ì˜ˆì • ì‚¬í•­']||''}</td>`;
          tbody.appendChild(tr);
        });
        // ìµœê·¼ í•­ëª© í‘œì‹œ
        const box = qs('#recentBox');
        if(rows.length>0){
          const last=rows[rows.length-1];
          box.textContent=`${fmtDate(last['ë‚ ì§œ'])} â€¢ ${last['í‚¤ë¡œìˆ˜']||''}km â€¢ ${last['í•­ëª©']}`;
        } else {
          box.textContent='ì•„ì§ ë°ì´í„° ì—†ìŒ';
        }
      }catch(e){ setStatus(qs('#formStatus'),'ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨: '+e.message,'error'); }
    }

    async function deleteSelected(){
      const checked=qsa('#table tbody input[type=checkbox]:checked');
      if(checked.length===0){ alert('ì‚­ì œí•  í•­ëª©ì„ ì„ íƒí•˜ì„¸ìš”'); return; }
      if(!confirm('ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
      const {url}=loadConfig();
      try{
        const indices = checked.map(cb => parseInt(cb.dataset.idx,10)+2).sort((a,b)=>b-a);
        for(const idx of indices){
          await fetch(url+'?deleteRow='+idx, {method:'POST'});
        }
        loadEntries();
      }catch(e){ alert('ì‚­ì œ ì‹¤íŒ¨: '+e.message); }
    }

    window.addEventListener('DOMContentLoaded',()=>{
      qs('#addBtn').addEventListener('click',addEntry);
      qs('#loadBtn').addEventListener('click',loadEntries);
      qs('#deleteBtn').addEventListener('click',deleteSelected);
      qs('#exportBtn').addEventListener('click',()=>{
        const rows=[["ë‚ ì§œ","í‚¤ë¡œìˆ˜","í•­ëª©","ê¸ˆì•¡","ë¹„ê³ ","ì‚¬ìœ ","ì°¸ê³ ì‚¬í•­","ì •ë¹„ ì˜ˆì • ì‚¬í•­"]];
        qsa('#table tbody tr').forEach(tr=>{const cols=qsa('td',tr).slice(1).map(td=> '"'+td.textContent.replaceAll('"','""')+'"'); rows.push(cols);});
        const csv=rows.map(r=>r.join(',')).join('\n');
        const blob=new Blob(["\ufeff"+csv],{type:'text/csv;charset=utf-8;'});
        const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='ì°¨ê³„ë¶€_ì •ë¹„ë‚´ì—­.csv'; a.click();
      });
      qs('#checkAll').addEventListener('change',e=>{ qsa('#table tbody input[type=checkbox]').forEach(cb=>cb.checked=e.target.checked); });

      // ì„¤ì • ë²„íŠ¼ & ëª¨ë‹¬ ì—°ê²°
      qs('#openSettings').addEventListener('click', openSettings);
      qs('#closeSettings').addEventListener('click', closeSettings);
      qs('#saveCfgBtn').addEventListener('click', ()=>{
        saveConfig({ url: qs('#cfgUrl').value, key: qs('#cfgKey').value });
        setStatus(qs('#cfgStatus'),'ì„¤ì •ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.','ok');
        setTimeout(()=>{ closeSettings(); loadEntries(); }, 500);
      });

      // URLì´ ì—†ìœ¼ë©´ ì„¤ì • ëª¨ë‹¬ ìë™ í‘œì‹œ # 221
      if(!localStorage.getItem('carlog:url')){
        openSettings();
      } else {
        loadEntries();
      }
    });
  </script>
</body>
</html>
