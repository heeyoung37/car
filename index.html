<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>차계부 정비내역 웹앱</title>
  <style>
    :root { --bg:#0f172a; --card:#111827; --ink:#e5e7eb; --muted:#94a3b8; --accent:#22d3ee; }
    *{ box-sizing: border-box; }
    body{ margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Noto Sans, "Apple SD Gothic Neo", "Nanum Gothic", sans-serif; background:var(--bg); color:var(--ink); }
    header{ padding:20px; border-bottom:1px solid #1f2937; position:sticky; top:0; background:linear-gradient(180deg,#0f172a 0%, rgba(15,23,42,0.9) 100%); backdrop-filter: blur(6px); z-index:10; }
    h1{ margin:0; font-size:20px; letter-spacing:0.3px; }
    .container{ max-width:1000px; margin:20px auto; padding:0 16px 40px; }
    .card{ background:var(--card); border:1px solid #1f2937; border-radius:16px; padding:16px; box-shadow: 0 10px 30px rgba(0,0,0,0.25); }
    .grid{ display:grid; gap:12px; }
    .grid.cols-3{ grid-template-columns: repeat(3, minmax(0,1fr)); }
    .row{ display:flex; gap:8px; align-items:center; }
    label{ font-size:12px; color:var(--muted); display:block; margin-bottom:6px; }
    input, select, textarea{ width:100%; padding:10px 12px; background:#0b1220; color:var(--ink); border:1px solid #1f2937; border-radius:10px; outline:none; }
    input:focus, textarea:focus{ border-color: var(--accent); box-shadow: 0 0 0 4px rgba(34,211,238,0.1); }
    textarea{ min-height:64px; resize:vertical; }
    .btns{ display:flex; flex-wrap:wrap; gap:10px; }
    button{ padding:10px 14px; border-radius:12px; border:1px solid #1f2937; cursor:pointer; background:#0b1220; color:var(--ink); }
    button.primary{ background: linear-gradient(135deg, #22d3ee, #3b82f6); border:none; color:#00131a; font-weight:700; }
    button:disabled{ opacity:0.6; cursor:not-allowed; }
    .help{ font-size:12px; color:var(--muted); }
    .status{ margin-top:8px; font-size:13px; }
    table{ width:100%; border-collapse: collapse; }
    th, td{ padding:10px; border-bottom:1px solid #1f2937; font-size:14px; text-align:left; vertical-align:top; }
    th{ position:sticky; top:70px; background:var(--card); z-index:5; }
    .pill{ padding:2px 8px; border-radius:999px; background:#0b1220; border:1px solid #1f2937; font-size:12px; color:var(--muted); }
    .right{ text-align:right; }
    .nowrap{ white-space:nowrap; }

    /* 설정 버튼 */
    .fab{ position: fixed; right: 18px; bottom: 18px; width: 52px; height: 52px; border-radius: 999px; display:flex; align-items:center; justify-content:center; background:linear-gradient(135deg,#22d3ee,#3b82f6); color:#00131a; border:none; box-shadow:0 10px 24px rgba(0,0,0,0.35); font-weight:800; font-size:18px; }

    /* 모달 */
    .modal-backdrop{ position:fixed; inset:0; background:rgba(0,0,0,0.55); display:none; align-items:center; justify-content:center; z-index:50; backdrop-filter: blur(2px); }
    .modal{ width:min(560px, 92vw); background:var(--card); border:1px solid #1f2937; border-radius:16px; padding:16px; box-shadow:0 20px 60px rgba(0,0,0,0.45); }
    .modal h2{ margin:0 0 8px; font-size:18px; }
    .modal .row-end{ display:flex; gap:8px; justify-content:flex-end; margin-top:12px; }
  </style>
</head>
<body>
  <header>
    <div class="container">
      <h1>🚗 차계부 정비내역 • 클라우드 저장</h1>
    </div>
  </header>

  <main class="container">
    <!-- 입력 폼 -->
    <section class="card" style="margin-bottom:16px;">
      <div class="grid cols-3">
        <div>
          <label>날짜 <span class="pill">필수</span></label>
          <input type="date" id="fDate" />
        </div>
        <div>
          <label>키로수</label>
          <input type="number" id="fOdo" inputmode="numeric" placeholder="예) 67500" />
        </div>
        <div>
          <label>항목 <span class="pill">필수</span></label>
          <input type="text" id="fItem" placeholder="예) 엔진오일 교환" />
        </div>
      </div>
      <div class="grid cols-3" style="margin-top:12px;">
        <div>
          <label>금액(원)</label>
          <input type="number" id="fCost" inputmode="numeric" placeholder="예) 59900" />
        </div>
        <div>
          <label>사유</label>
          <input type="text" id="fReason" placeholder="예) 방전 / 소모품 교환 등" />
        </div>
        <div>
          <label>비고</label>
          <input type="text" id="fNote" placeholder="예) 매장/부품/오일 규격 등" />
        </div>
      </div>
      <div class="grid" style="margin-top:12px;">
        <div>
          <label>참고사항</label>
          <textarea id="fRef" placeholder="정비에 참고할 메모"></textarea>
        </div>
        <div>
          <label>정비 예정 사항</label>
          <textarea id="fNext" placeholder="다음 교환주기/예정 작업"></textarea>
        </div>
      </div>
      <div class="btns" style="margin-top:12px;">
        <button class="primary" id="addBtn">추가</button>
        <button id="loadBtn">목록 새로고침</button>
        <button id="exportBtn">CSV 내보내기</button>
        <span class="help">※ 저장이 안되면 Apps Script 웹앱 URL 및 권한 설정을 확인하세요.</span>
      </div>
      <div class="status" id="formStatus"></div>
    </section>

    <!-- 목록 -->
    <section class="card">
      <div class="row" style="justify-content:space-between; margin-bottom:8px;">
        <div class="help">시트의 헤더(1행)는 <b>날짜, 키로수, 항목, 금액, 비고, 사유, 참고사항, 정비 예정 사항</b> 순서여야 합니다.</div>
        <div class="pill"><span id="count">0</span> 건</div>
      </div>
      <div style="overflow:auto;">
        <table id="table">
          <thead>
            <tr>
              <th class="nowrap">날짜</th>
              <th class="nowrap">키로수</th>
              <th>항목</th>
              <th class="right">금액</th>
              <th>비고</th>
              <th>사유</th>
              <th>참고사항</th>
              <th>정비 예정 사항</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </section>
  </main>

  <!-- 설정 플로팅 버튼 -->
  <button class="fab" id="openSettings" title="설정">⚙</button>

  <!-- 설정 모달 -->
  <div class="modal-backdrop" id="settingsModal">
    <div class="modal">
      <h2>연결 설정</h2>
      <div class="grid cols-3">
        <div style="grid-column: span 3;">
          <label>Apps Script 웹앱 URL</label>
          <input id="cfgUrl" placeholder="예) https://script.google.com/macros/s/AKfycb.../exec" />
        </div>
        <div style="grid-column: span 3;">
          <label>API Key (선택)</label>
          <input id="cfgKey" placeholder="스크립트 속성에 설정한 값" />
        </div>
      </div>
      <div class="row-end">
        <button id="closeSettings">닫기</button>
        <button class="primary" id="saveCfgBtn">저장</button>
      </div>
      <div class="status" id="cfgStatus"></div>
    </div>
  </div>

  <script>
    const qs = (s,root=document)=> root.querySelector(s);
    const qsa = (s,root=document)=> [...root.querySelectorAll(s)];

    function setStatus(el,msg,type='info'){
      if(!el) return;
      el.textContent = msg;
      el.style.color = type==='error' ? '#fca5a5' : (type==='ok' ? '#86efac' : '#94a3b8');
    }

    // === 설정 저장/불러오기 ===
    function loadConfig(){
      return {
        url: localStorage.getItem('carlog:url') || '',
        key: localStorage.getItem('carlog:key') || ''
      };
    }
    function saveConfig({url, key}){
      localStorage.setItem('carlog:url', (url||'').trim());
      localStorage.setItem('carlog:key', (key||'').trim());
    }

    function openSettings(){
      const {url,key} = loadConfig();
      qs('#cfgUrl').value = url;
      qs('#cfgKey').value = key;
      qs('#settingsModal').style.display = 'flex';
      setStatus(qs('#cfgStatus'), '브라우저에만 저장됩니다.');
    }
    function closeSettings(){ qs('#settingsModal').style.display = 'none'; }

    // === 폼 직렬화 ===
    function serializeForm(){
      const d = qs('#fDate').value;
      const item = qs('#fItem').value.trim();
      const odo = qs('#fOdo').value;
      const cost = qs('#fCost').value;
      const reason = qs('#fReason').value.trim();
      const note = qs('#fNote').value.trim();
      const ref = qs('#fRef').value.trim();
      const next = qs('#fNext').value.trim();
      if(!d || !item) throw new Error('날짜와 항목은 필수입니다.');
      const dateStr = new Date(d).toISOString().slice(0,10);
      const {key} = loadConfig();
      return {
        apiKey: key || undefined,
        '날짜': dateStr,
        '키로수': odo || '',
        '항목': item,
        '금액': cost || '',
        '비고': note,
        '사유': reason,
        '참고사항': ref,
        '정비 예정 사항': next,
      };
    }

    async function addEntry(){
      setStatus(qs('#formStatus'),'저장 중...');
      qs('#addBtn').disabled = true;
      try{
        const {url} = loadConfig();
        if(!url) throw new Error('설정에서 웹앱 URL을 먼저 저장하세요. (오른쪽 아래 ⚙)');
        const body = serializeForm();
        const res = await fetch(url, { method:'POST', headers:{'Content-Type':'text/plain;charset=utf-8'}, body: JSON.stringify(body)});
        const data = await res.json();
        if(!data.ok) throw new Error(data.error || '저장 실패');
        setStatus(qs('#formStatus'),'저장 완료!','ok');
        qsa('input[type="text"], input[type="number"], textarea').forEach(el=> el.value='');
        await loadEntries();
      }catch(err){ setStatus(qs('#formStatus'),'저장 실패: '+err.message,'error'); }
      finally{ qs('#addBtn').disabled = false; }
    }

    function fmtMoney(x){ if(!x) return ''; const n = Number(String(x).replace(/[^\d.-]/g,'')); return isNaN(n) ? x : n.toLocaleString('ko-KR'); }
    function fmtDate(v){ if(!v) return ''; const d = new Date(v); return isNaN(d) ? v : d.toISOString().slice(0,10); }

    async function loadEntries(){
      const tbody = qs('#table tbody');
      tbody.innerHTML = '';
      qs('#count').textContent = '0';
      try{
        const {url,key} = loadConfig();
        if(!url) throw new Error('설정에서 웹앱 URL을 먼저 저장하세요. (오른쪽 아래 ⚙)');
        const res = await fetch(url + '?list=1');
        const data = await res.json();
        if(!data.ok) throw new Error(data.error || '목록 불러오기 실패');
        const rows = data.data || [];
        qs('#count').textContent = rows.length;
        rows.forEach(r=>{
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td class="nowrap">${fmtDate(r['날짜'])}</td>
            <td class="nowrap">${r['키로수'] ?? ''}</td>
            <td>${r['항목'] ?? ''}</td>
            <td class="right">${fmtMoney(r['금액'])}</td>
            <td>${r['비고'] ?? ''}</td>
            <td>${r['사유'] ?? ''}</td>
            <td>${r['참고사항'] ?? ''}</td>
            <td>${r['정비 예정 사항'] ?? ''}</td>`;
          tbody.appendChild(tr);
        });
        setStatus(qs('#formStatus'),'불러오기 완료','ok');
      }catch(err){ setStatus(qs('#formStatus'),'불러오기 실패: '+err.message,'error'); }
    }

    function exportCSV(){
      const rows = [["날짜","키로수","항목","금액","비고","사유","참고사항","정비 예정 사항"]];
      qsa('#table tbody tr').forEach(tr=>{ const cols = qsa('td', tr).map(td=> '"'+ td.textContent.replaceAll('"','""') +'"'); rows.push(cols); });
      const csv = rows.map(r=> r.join(',')).join('\n');
      const blob = new Blob(["\ufeff"+csv],{type:'text/csv;charset=utf-8;'});
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob); a.download = '차계부_정비내역.csv'; a.click(); URL.revokeObjectURL(a.href);
    }

    window.addEventListener('DOMContentLoaded', () => {
      qs('#addBtn').addEventListener('click', addEntry);
      qs('#loadBtn').addEventListener('click', loadEntries);
      qs('#exportBtn').addEventListener('click', exportCSV);
      qs('#openSettings').addEventListener('click', openSettings);
      qs('#closeSettings').addEventListener('click', closeSettings);
      qs('#saveCfgBtn').addEventListener('click', ()=>{
        saveConfig({ url: qs('#cfgUrl').value, key: qs('#cfgKey').value });
        setStatus(qs('#cfgStatus'),'설정이 저장되었습니다.','ok');
        setTimeout(closeSettings, 600);
        loadEntries();
      });

      // 첫 방문 시 설정 안내 모달 자동 표시 (URL 없으면)
      if(!localStorage.getItem('carlog:url')){
        openSettings();
      } else {
        loadEntries();
      }
    });
  </script>
</body>
</html>
